<template>
  <div class="row post-title px-5">
    <div class="col-6">
      <LayoutMediaFocus
        :source="getStrapiUrl(post.attributes.Image)"
        :title="post.attributes.Title"
      />
    </div>
    <div class="col-6 d-flex align-items-center">
      <h1 class="pb-5">{{ post.attributes.Title }}</h1>
    </div>
  </div>
  <div class="row p-5 post-display">
    <div class="col-3">
      <BlogTOC :content="post.attributes.Content" />
    </div>
    <div
      class="col-6"
      data-bs-spy="scroll"
      data-bs-target="#toc"
      data-bs-smooth-scroll="true"
    >
      <BlogRichText
        :block="post.attributes.Content"
      />
      <BlogRichText
        :block="post.attributes.CTA"
      />
    </div>
    <div class="col-3">
      <div class="position-sticky top-0">
        <LayoutPostListSidebar
          title="Related Articles"
          :posts="relatedPosts"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import { isEmpty } from 'lodash'

definePageMeta({
  layout: 'blog'
})

const { path } = useRoute()

const {
  data: {
   value: 
    { posts: 
      { data: [post] }
    }
  }
} = await useAsyncQuery(singlePostQuery(path.split('/').pop()))

console.debug('post: ', post)
const {
  attributes: {
    category: {
      data: {
        attributes: {
          Name: category
        }
      }
    }
  }
} = post

let {
  data: {
    value: {
      categories: {
        data: [{
          attributes: {
            posts: { data: relatedPosts }
          }
        }]
      }
    }
  }
} = await useAsyncQuery(categoryPostsQuery(category))

relatedPosts = relatedPosts.filter(relatedPost => {
  return relatedPost.id !== post.id
})

if (isEmpty(post)) {
  showError({'404': 'Page not found'})
}
</script>

<style lang="scss">
.post-title {
  background: #d8d8d8;
}
</style>